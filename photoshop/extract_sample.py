import os
from PIL import Image

import numpy as np

from traits import *


image_dir = "image/original_image"
save_dir = "image/trait/candidate"

face = Male()
face_type = "Female"

skin_colors = ['0x713f1d', '0xae8b61', '0xdbb180', '0xead9d9']
skin = "Milk"
skin_color = skin_colors[3]

token_ids = assets[np.logical_and(assets.face_type == face_type, assets.skin_color == skin_color)]["token_id"].tolist()
# token_ids = [10, 12, 14, 19, 22, 25, 31, 37, 42, 49, 62, 66, 67, 85, 86, 89, 94, 103, 110, 114, 115, 116, 140, 161, 173, 176, 180, 184, 191, 200, 209, 212, 219, 232, 242, 245, 247, 248, 253, 261, 262, 303, 316, 326, 357, 374, 378, 391, 417, 418, 425, 427, 428, 430, 431, 440, 443, 445, 464, 471, 474, 493, 504, 509, 532, 534, 537, 545, 548, 553, 554, 579, 580, 584, 585, 588, 590, 597, 601, 618, 646, 660, 670, 671, 675, 688, 689, 697, 708, 721, 727, 737, 749, 757, 758, 759, 761, 776, 780, 822, 832, 835, 844, 861, 874, 876, 898, 901, 907, 912, 914, 927, 931, 974, 982, 1000, 1004, 1015, 1023, 1024, 1035, 1039, 1040, 1052, 1071, 1086, 1090, 1130, 1140, 1158, 1200, 1212, 1227, 1246, 1265, 1276, 1277, 1289, 1295, 1296, 1299, 1302, 1318, 1332, 1339, 1341, 1345, 1346, 1352, 1355, 1364, 1367, 1372, 1382, 1388, 1413, 1415, 1417, 1434, 1441, 1442, 1446, 1449, 1461, 1471, 1476, 1485, 1493, 1498, 1512, 1514, 1527, 1535, 1544, 1547, 1548, 1556, 1561, 1595, 1598, 1621, 1634, 1645, 1652, 1664, 1666, 1670, 1684, 1693, 1707, 1711, 1724, 1738, 1740, 1742, 1749, 1750, 1754, 1761, 1796, 1803, 1813, 1815, 1816, 1818, 1827, 1835, 1838, 1841, 1847, 1855, 1856, 1860, 1869, 1870, 1877, 1885, 1902, 1906, 1907, 1924, 1930, 1931, 1940, 1949, 1953, 1956, 1974, 1980, 1982, 1988, 2000, 2008, 2012, 2014, 2017, 2019, 2022, 2041, 2047, 2052, 2053, 2054, 2067, 2068, 2085, 2095, 2100, 2103, 2117, 2118, 2129, 2133, 2134, 2142, 2149, 2150, 2168, 2170, 2171, 2177, 2181, 2197, 2199, 2202, 2204, 2208, 2222, 2226, 2244, 2257, 2275, 2279, 2299, 2312, 2321, 2324, 2339, 2346, 2351, 2381, 2382, 2395, 2397, 2398, 2403, 2409, 2411, 2422, 2431, 2445, 2462, 2475, 2478, 2486, 2487, 2516, 2525, 2527, 2531, 2546, 2563, 2578, 2594, 2602, 2613, 2618, 2623, 2649, 2660, 2676, 2690, 2696, 2705, 2710, 2716, 2723, 2734, 2741, 2742, 2756, 2760, 2761, 2782, 2792, 2800, 2807, 2808, 2812, 2813, 2814, 2821, 2828, 2831, 2832, 2837, 2841, 2843, 2850, 2858, 2888, 2889, 2896, 2904, 2905, 2909, 2915, 2918, 2919, 2920, 2937, 2945, 2950, 2966, 2973, 2974, 2994, 2997, 3002, 3008, 3025, 3034, 3037, 3042, 3057, 3058, 3059, 3087, 3105, 3110, 3113, 3119, 3139, 3148, 3153, 3165, 3166, 3170, 3190, 3219, 3220, 3231, 3254, 3267, 3269, 3289, 3290, 3311, 3333, 3348, 3351, 3354, 3356, 3360, 3366, 3371, 3376, 3385, 3386, 3401, 3409, 3417, 3430, 3431, 3432, 3435, 3437, 3453, 3470, 3479, 3480, 3483, 3494, 3498, 3502, 3515, 3519, 3527, 3529, 3558, 3590, 3592, 3593, 3608, 3616, 3617, 3621, 3628, 3629, 3646, 3649, 3659, 3663, 3674, 3705, 3711, 3723, 3734, 3757, 3763, 3774, 3775, 3788, 3789, 3793, 3795, 3798, 3807, 3823, 3827, 3828, 3853, 3856, 3858, 3864, 3870, 3898, 3899, 3911, 3918, 3920, 3932, 3940, 3950, 3964, 3965, 3974, 3976, 3981, 3985, 3986, 3995, 3997, 3999, 4009, 4015, 4037, 4048, 4069, 4072, 4074, 4075, 4078, 4085, 4089, 4100, 4103, 4105, 4112, 4146, 4149, 4152, 4161, 4191, 4195, 4196, 4198, 4200, 4214, 4229, 4231, 4236, 4245, 4250, 4265, 4273, 4275, 4276, 4277, 4294, 4300, 4315, 4319, 4332, 4334, 4340, 4374, 4383, 4396, 4398, 4432, 4443, 4449, 4461, 4467, 4500, 4502, 4514, 4525, 4535, 4537, 4545, 4554, 4563, 4568, 4571, 4573, 4575, 4584, 4585, 4597, 4606, 4612, 4615, 4625, 4627, 4634, 4671, 4676, 4677, 4681, 4682, 4711, 4726, 4742, 4752, 4761, 4767, 4772, 4782, 4788, 4798, 4814, 4815, 4829, 4848, 4859, 4882, 4886, 4887, 4893, 4911, 4912, 4922, 4931, 4935, 4943, 4946, 4961, 4979, 4983, 4985, 5001, 5005, 5009, 5011, 5027, 5040, 5042, 5053, 5054, 5060, 5067, 5068, 5074, 5076, 5083, 5115, 5117, 5137, 5153, 5165, 5166, 5168, 5180, 5181, 5183, 5190, 5195, 5202, 5210, 5222, 5236, 5254, 5256, 5264, 5267, 5271, 5279, 5307, 5339, 5340, 5348, 5376, 5385, 5386, 5407, 5441, 5446, 5457, 5462, 5490, 5493, 5497, 5507, 5516, 5524, 5525, 5534, 5554, 5560, 5562, 5566, 5572, 5578, 5587, 5590, 5608, 5615, 5619, 5622, 5623, 5637, 5638, 5670, 5682, 5684, 5697, 5698, 5703, 5704, 5723, 5748, 5751, 5757, 5759, 5771, 5772, 5781, 5783, 5809, 5811, 5813, 5834, 5836, 5838, 5852, 5863, 5873, 5890, 5901, 5917, 5919, 5928, 5929, 5931, 5934, 5945, 5949, 5955, 5972, 5991, 5998, 6003, 6028, 6038, 6043, 6071, 6077, 6088, 6099, 6102, 6107, 6111, 6113, 6125, 6144, 6152, 6163, 6164, 6170, 6197, 6199, 6205, 6206, 6221, 6224, 6230, 6235, 6239, 6257, 6273, 6298, 6305, 6309, 6323, 6341, 6348, 6352, 6365, 6369, 6371, 6376, 6390, 6430, 6448, 6451, 6454, 6462, 6465, 6468, 6483, 6490, 6497, 6509, 6513, 6532, 6549, 6554, 6559, 6560, 6564, 6581, 6588, 6603, 6612, 6620, 6625, 6626, 6629, 6651, 6663, 6674, 6681, 6688, 6695, 6718, 6727, 6734, 6752, 6757, 6762, 6763, 6767, 6794, 6796, 6804, 6806, 6808, 6811, 6812, 6834, 6836, 6859, 6860, 6872, 6875, 6880, 6881, 6882, 6884, 6903, 6904, 6910, 6931, 6932, 6950, 6963, 6972, 6997, 6998, 7009, 7011, 7015, 7043, 7044, 7056, 7074, 7081, 7082, 7083, 7085, 7093, 7101, 7104, 7111, 7131, 7155, 7204, 7212, 7216, 7234, 7259, 7260, 7288, 7292, 7295, 7299, 7300, 7304, 7306, 7325, 7326, 7327, 7336, 7342, 7354, 7391, 7392, 7397, 7415, 7419, 7429, 7456, 7484, 7486, 7495, 7506, 7509, 7528, 7532, 7545, 7587, 7593, 7601, 7604, 7626, 7663, 7693, 7703, 7734, 7735, 7736, 7749, 7750, 7758, 7763, 7791, 7794, 7801, 7805, 7813, 7826, 7830, 7832, 7834, 7850, 7857, 7874, 7894, 7897, 7919, 7935, 7942, 7967, 7973, 7978, 7982, 7987, 7994, 8007, 8027, 8030, 8039, 8063, 8066, 8089, 8092, 8094, 8115, 8126, 8147, 8150, 8164, 8168, 8176, 8184, 8201, 8209, 8218, 8240, 8241, 8269, 8276, 8279, 8284, 8287, 8300, 8308, 8310, 8320, 8331, 8349, 8351, 8352, 8354, 8360, 8364, 8365, 8394, 8428, 8436, 8438, 8447, 8454, 8467, 8470, 8483, 8487, 8493, 8505, 8512, 8519, 8524, 8537, 8539, 8560, 8565, 8577, 8580, 8589, 8592, 8600, 8621, 8629, 8630, 8647, 8656, 8663, 8665, 8680, 8683, 8697, 8725, 8726, 8732, 8733, 8746, 8760, 8763, 8764, 8766, 8773, 8774, 8776, 8797, 8804, 8807, 8809, 8810, 8813, 8822, 8842, 8856, 8858, 8867, 8873, 8883, 8887, 8888, 8891, 8916, 8917, 8922, 8932, 8944, 8959, 8994, 8997, 9000, 9001, 9013, 9014, 9021, 9030, 9035, 9041, 9042, 9050, 9057, 9066, 9067, 9068, 9081, 9127, 9147, 9151, 9167, 9183, 9211, 9213, 9217, 9223, 9228, 9240, 9244, 9257, 9301, 9304, 9311, 9324, 9326, 9338, 9353, 9358, 9369, 9376, 9377, 9379, 9383, 9409, 9411, 9419, 9430, 9438, 9451, 9455, 9457, 9461, 9468, 9470, 9481, 9482, 9483, 9485, 9486, 9490, 9495, 9503, 9529, 9532, 9571, 9572, 9598, 9606, 9608, 9629, 9632, 9640, 9641, 9662, 9691, 9710, 9719, 9727, 9729, 9740, 9755, 9781, 9791, 9801, 9806, 9828, 9831, 9832, 9840, 9846, 9849, 9866, 9867, 9898, 9903, 9907, 9919, 9928, 9941, 9942, 9981, 9989, 9994, 9999]

# token_id = "372"
for token_id in token_ids:
    filename = f"cryptopunk{token_id}.png"
    filepath = os.path.join(image_dir, filename)
    with Image.open(filepath) as img:
        img_array = np.array(img.convert("RGBA"))
    # component_types = ["Eyes", "Eyeballs", "Eyebrows", "Nose", "Lip"]
    # comp = face.extract_component(img_array, face.get_eye_pos())
    # savefilepath = os.path.join(save_dir, f"{face_type}{skin}Eyes{token_id}.png")
    # comp.save(savefilepath)
    # comp = face.extract_component(img_array, face.get_eyeball_pos())
    # savefilepath = os.path.join(save_dir, f"{face_type}{skin}Eyeballs{token_id}.png")
    # comp.save(savefilepath)
    # comp = face.extract_component(img_array, face.get_eyebrow_pos())
    # savefilepath = os.path.join(save_dir, f"{face_type}{skin}Eyebrows{token_id}.png")
    # comp.save(savefilepath)
    # comp = face.extract_component(img_array, face.get_nose_pos())
    # savefilepath = os.path.join(save_dir, f"{face_type}{skin}Nose{token_id}.png")
    # comp.save(savefilepath)
    comp = face.extract_component(img_array, face.get_mouth_pos())
    savefilepath = os.path.join(save_dir, f"{face_type}{skin}Lip{token_id}.png")
    comp.save(savefilepath)


# skin = "Milk"

# 36
token_id = 7523
filename = f"cryptopunk{token_id}.png"
filepath = os.path.join(image_dir, filename)
with Image.open(filepath) as img:
    img_array = np.array(img.convert("RGBA"))

# component_types = ["Eyes", "Eyeballs", "Eyebrows", "Nose", "Lip"]

comp = face.extract_component(img_array, face.get_eye_pos())
savefilepath = os.path.join(save_dir, f"{face_type}{skin}Eyes.png")
comp.save(savefilepath)
# comp = face.extract_component(img_array, face.get_eyeball_pos())
# savefilepath = os.path.join(save_dir, f"{face_type}{skin}Eyeballs.png")
# comp.save(savefilepath)
comp = face.extract_component(img_array, face.get_eyebrow_pos())
savefilepath = os.path.join(save_dir, f"{face_type}{skin}EyeShadow.png")
comp.save(savefilepath)
comp = face.extract_component(img_array, face.get_nose_pos())
savefilepath = os.path.join(save_dir, f"{face_type}{skin}Nose.png")
comp.save(savefilepath)
comp = face.extract_component(img_array, face.get_mouth_pos())
savefilepath = os.path.join(save_dir, f"{face_type}{skin}Lip.png")
comp.save(savefilepath)

poslist = face.get_eyeball_pos()
color = img_array[poslist[0][1]*14-1, poslist[0][3]*14-1]
new_img_array = np.tile(face.TRANSPARENT_COLOR, (face.WIDTH, face.HEIGHT, 1))
for pos in poslist:
    new_img_array[pos[0] * face.PIXEL_PER_DOT:pos[1] * face.PIXEL_PER_DOT, pos[2] * face.PIXEL_PER_DOT:pos[3] * face.PIXEL_PER_DOT] = color

savefilepath = os.path.join(save_dir, f"{face_type}{skin}Eyeballs.png")
comp = Image.fromarray(new_img_array.astype(np.uint8), 'RGBA')
comp.save(savefilepath)


skin_colors = ['0x713f1d', '0xae8b61', '0xdbb180', '0xead9d9']
assets[np.logical_and(assets.skin_color == "0xae8b61", assets.face_type == "Male")]
assets[np.logical_and(assets.skin_color == "0xdbb180", assets.face_type == "Male")]
assets[np.logical_and(assets.skin_color == "0xead9d9", assets.face_type == "Male")]


for f in sorted(newfiles):
    filepath = os.path.join(save_dir, f)
    with Image.open(filepath) as img:
        new_img = np.array(img.convert("RGBA"))
    filepath = os.path.join(org_dir, f)
    with Image.open(filepath) as img:
        org_img = np.array(img.convert("RGBA"))
    print(f, np.all(org_img == new_img))

